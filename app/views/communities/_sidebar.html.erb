<% content_for :javascript do %>

<script type="text/javascript">
(function() {
  var template =
    '<div class="map-location biz" data-jmapping=\'{{json}}\'>' +
      '<div class="info-box clearfix">' + 
        '<h4><a href="{{url}}">{{name}}</a></h4>' +
        '<div class="info-photo"><a href="{{url}}"><img src="{{photo_img}}" /></a></div>' +
        '<div class="info-content"><img src="{{rating_img}}" /><p>{{address}}</p></div>' +
      '</div>' +
    '</div>';

  function updateMap() {
    $('#large-map').data('jMapping').update();
  }

  function formatPhone(phone) {
    if (phone.length == 10) {
      return '('+phone.substr(0, 3)+') '+phone.substr(3, 3)+'-'+phone.substr(6, 4);
    } else {
      return phone;
    }
  }

  function search(categories) {
    var returned = 0;

    if (categories.length == 0) {
      updateMap();
      return;
    }

    $.each(categories, function(category_index, category) {
      var url = 'http://api.yelp.com/business_review_search?' + $.param({
        category: category,
        ywsid: <%= APP_CONFIG[:yelp_api_key].inspect.html_safe %>,
        lat: <%= @community.latitude %>,
        long: <%= @community.longitude %>,
        limit: 8,
        radius: 5
      });

      $.get(url, {}, function(data, status) {
        $.each(data.businesses, function(index, biz) {
          var div = template;
          var biz_object = {
            category: category,
            id:       ((category_index*1000)+(index)+2),
            point:    {
              lat: biz.latitude,
              lng: biz.longitude
            }
          };

          var address = [biz.address1, biz.address2, biz.address3, biz.city + ', ' + biz.state_code + ' ' + biz.zip, formatPhone(biz.phone)];
          address = $.map(address, function(e) {
            if (e != "") {
              return e;
            }
          });

          div = div.replace('{{json}}', JSON.stringify(biz_object));
          div = div.replace('{{name}}', biz.name);
          div = div.replace('{{url}}', biz.url);
          div = div.replace('{{rating_img}}', biz.rating_img_url_small);
          div = div.replace('{{photo_img}}', biz.photo_url_small);
          div = div.replace('{{address}}', address.join('<br />'));

          $('#large-map-side-bar').append(div);
        });
        updateMap();
      }, 'jsonp');
    });
  }

  $(document).ready(function() {
    $('#map-canvas').jMapping({
      default_zoom_level: 13
    });

    $("#map-lightbox").click(function (e) {
      e.preventDefault();
      $("#large-map-container").lightbox_me({
        onLoad: function () {
          var baseIcon = new GIcon(G_DEFAULT_ICON);
          baseIcon.iconSize = new GSize(32, 37);
          baseIcon.iconAnchor = new GPoint(16, 37);
          baseIcon.infoWindowAnchor = new GPoint(16, 0);
          baseIcon.shadow = null;

          $('#large-map').css({ height: '420px', width: '850px' });

          $('#large-map').jMapping({
            category_icon_options: function(category) {
              var icon = new GIcon(baseIcon);

              switch(category) {
                case 'fitness':
                  icon.image = 'http://google-maps-icons.googlecode.com/files/fitnesscenter.png';
                  break;
                case 'parks':
                  icon.image = 'http://google-maps-icons.googlecode.com/files/park-urban.png';
                  break;
                case 'arts':
                  icon.image = 'http://google-maps-icons.googlecode.com/files/music-classical.png';
                  break;
                case 'beautysvc':
                  icon.image = 'http://google-maps-icons.googlecode.com/files/aestheticscenter.png';
                  break;
                case 'education':
                  icon.image = 'http://google-maps-icons.googlecode.com/files/school.png';
                  break;
                case 'coffee':
                  icon.image = 'http://google-maps-icons.googlecode.com/files/coffee.png';
                  break;
                case 'grocery':
                  icon.image = 'http://google-maps-icons.googlecode.com/files/grocery.png';
                  break;
                case 'hospitals':
                  icon.image = 'http://google-maps-icons.googlecode.com/files/hospital.png';
                  break;
                case 'transport':
                  icon.image = 'http://google-maps-icons.googlecode.com/files/bus.png';
                  break;
                case 'hotels':
                  icon.image = 'http://google-maps-icons.googlecode.com/files/hotel.png';
                  break;
                case 'drycleaninglaundry':
                  icon.image = 'http://google-maps-icons.googlecode.com/files/clothes.png';
                  break;
                case 'bars':
                  icon.image = 'http://google-maps-icons.googlecode.com/files/bar.png';
                  break;
                case 'petservices':
                  icon.image = 'http://google-maps-icons.googlecode.com/files/pets.png';
                  break;
                case 'restaurants':
                  icon.image = 'http://google-maps-icons.googlecode.com/files/restaurant.png';
                  break;
                case 'shopping':
                  icon.image = 'http://google-maps-icons.googlecode.com/files/shoppingmall.png';
                  break;
                default:
                  icon.image = 'http://google-maps-icons.googlecode.com/files/home.png';
                  break;
              }

              return icon;
            },
            default_zoom_level: 13,
            side_bar_selector: '#large-map-side-bar:first'
          });

          var categories = new Array;
          $('#large-map-controls input[name=categories]:checked').map(function() {
            categories.push($(this).val());
          });
          search(categories);

          $('#large-map-controls input').click(function(e) {
            $('#large-map-side-bar .biz').remove();
            categories = new Array;
            $('#large-map-controls input[name=categories]:checked').map(function() {
              categories.push($(this).val());
            });

            search(categories);
          });
        }
      });
    });

  });
})();
</script>
<% end %>

<div id="sidebar" class="col">
  <div id="community-info" class="article row">
    <ul class="nav row">
      <li>
        <%= link_to 'View Map', '#map' %>
      </li>
      <li>
        <%= link_to 'Walk Score&trade;'.html_safe, '#walk-score' %>
      </li>
      <% if @community.has_local_info? %>
        <li class="last">
          <%= link_to 'Local Info', '#local-info' %>
        </li>
      <% end %>
    </ul>

    <div id="map" class="section">
      <div id="map-canvas"></div>
      <div id="map-side-bar" style="display:none;">
        <div class="map-location" data-jmapping="{id:1, point: {lat:<%= @community.latitude %>, lng:<%= @community.longitude %>}}">
          <div class="info-box">
          <h4><%= h @community.title %></h4>
          </div>
        </div>
      </div>
      <p class="call-to-action">
        <%= link_to 'View Larger', "#", :id => 'map-lightbox' %>
      </p>
    </div>

    <div id="walk-score" class="section">
      <%= walkscore_map_script(@community) %>
    </div>

    <% if @community.has_local_info? %>
      <div id="local-info" class="section">
        <% @community.local_info.take(5).each do |info| %>
          <div class="local-info">
            <h4><%= link_to info.title.gsub(/on Yelp$/, ''), info.url %></h4>

            <p class="date">
              <%= info.published_at.to_formatted_s(:month_day_year) %>
            </p>

            <p>
              <%= truncate_html(raw(info.description), :length => 75) %>
            </p>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <%= yield :sidebar %>

  <div class="social-updates">
    <%= facebook_like_link(request.url) %>

    <% if @community.facebook_url.present? %>
      <p class="facebook-link">
        <%= link_to 'Follow on Facebook', @community.facebook_url, :rel => 'external' %>
      </p>
    <% end %>

    <% if @community.twitter_handle.present? %>
      <div class="twitter-update" <%= twitter_data_attr(@community.twitter_handle) %>></div>
    <% end %>

    <%= share_this_link %>
  </div>
</div>

<% content_for :end_of_body do %>

  <div id="large-map-container">
    <div id="large-map">

    </div>
    <div id="large-map-controls">

      <a href="http://www.yelp.com/" id="large-map-yelp-logo">
        <img src="/images/structure/yelp_logo_50x25.png" width="50" height="25">
      </a>

      <h3>Points of Interest</h3>

      <label>
        <input type="checkbox" name="categories" value="fitness" checked="checked" />
        Fitness and Instruction
      </label>

      <label>
        <input type="checkbox" name="categories" value="parks" checked="checked" />
        Parks
      </label>

      <label>
        <input type="checkbox" name="categories" value="arts" checked="checked" />
        Arts and Entertainment
      </label>

      <label>
        <input type="checkbox" name="categories" value="beautysvc" checked="checked" />
        Beauty and Spas
      </label>

      <label>
        <input type="checkbox" name="categories" value="education" checked="checked" />
        Education
      </label>

      <label>
        <input type="checkbox" name="categories" value="coffee" checked="checked" />
        Coffee and Tea
      </label>

      <label>
        <input type="checkbox" name="categories" value="grocery" checked="checked" />
        Grocery
      </label>

      <label>
        <input type="checkbox" name="categories" value="hospitals" checked="checked" />
        Hospitals
      </label>

      <label>
        <input type="checkbox" name="categories" value="transport" checked="checked" />
        Transportation
      </label>

      <label>
        <input type="checkbox" name="categories" value="hotels" checked="checked" />
        Hotels
      </label>

      <label>
        <input type="checkbox" name="categories" value="drycleaninglaundry" checked="checked" />
        Dry Cleaning / Laundry
      </label>

      <label>
        <input type="checkbox" name="categories" value="bars" checked="checked" />
        Bars
      </label>

      <label>
        <input type="checkbox" name="categories" value="petservices" checked="checked" />
        Pet Services
      </label>

      <label>
        <input type="checkbox" name="categories" value="restaurants" checked="checked" />
        Restaurants
      </label>

      <label>
        <input type="checkbox" name="categories" value="shopping" checked="checked" />
        Shopping
      </label>

      <div id="large-map-side-bar">
        <div class="map-location" data-jmapping="{id:1, point: {lat:<%= @community.latitude %>, lng:<%= @community.longitude %>}}">
          <div class="info-box">
            <h4><%= h @community.title %></h4>
          </div>
        </div>
      </div>
    </div>
  </div>

<% end %>
