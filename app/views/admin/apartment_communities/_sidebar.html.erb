<% if %w(index edit).include? params[:action] %>
  <div class="module">
    <h2>External Feeds</h2>

    <% if params[:action] == 'index' %>
      <ul class="external-feeds">
        <% Bozzuto::ExternalFeedLoader.feed_types.each do |type| %>
          <% loader = Bozzuto::ExternalFeedLoader.loader_for_type(type) %>
          <li>
            <h3><%= loader.feed_name %></h3>

            <%= link_to 'View All', :external_cms_type => type %><br />

            <% if loader.can_load_feed? %>
              <%= link_to 'Refresh Feed', {
                    :controller => 'admin/external_feeds',
                    :action     => :load,
                    :feed_type  => loader.feed_type.to_s
                  },
                  :method => :post,
                  :class => 'refresh-feed' %>

              <span class="external-cms-message please-wait">
                <%= image_tag 'spinner.gif' %>
                Refreshing feed, please wait (this may take awhile)&hellip;
              </span>
            <% else %>
              <span class="external-cms-message">
                <%= distance_of_time_in_words(Time.now, loader.next_load_time).capitalize %> until next refresh
              </span>
            <% end %>
          </li>
        <% end %>
      </ul>

      <p class="refresh-interval">
        <em>Feeds can be refreshed once every two hours.</em>
      </p>
    <% end %>


    <% if params[:action] == 'edit' %>
      <ul>
        <li>
          <% if @item.managed_externally? %>
            <span class="external-cms-message">
              Managed by <%= @item.external_cms_name %>.
            </span>
          <% else %>
            <%= link_to 'Merge with a feed property', :action => :merge, :id => @item.id %>
          <% end %>
        </li>
      </ul>
    <% end %>
  </div>
<% end %>
